<extend name="Public/base"/>

<block name="style">
    <link rel="stylesheet" href="__CSS__/BeatPicker.min.css"/>
    <link rel="stylesheet" href="__CSS__/newStyle.css"/>
    <style type="text/css">

    </style>
</block>
<block name="body">
    <div class="souye">
        <div class="box">
            <div class="top">
                <h2>资产盈亏折线图</h2>
                <input type="text" id="branch" class="branch" placeholder="选择部门" readonly>
                <ul id="ul">
                    <volist name="branch_name" id="item">
                        <li>{$item['name']}</li>
                    </volist>
                </ul>
                <div  style="display: inline-block;margin-left: -50px">
                    <input type="text" id="start" class="time" placeholder="开始时间" readonly data-beatpicker="true" data-beatpicker-module="clear">
                </div>
                <div  style="display: inline-block;margin-left: 100px">
                    <input type="text" id="end" class="time timeML" placeholder="结束时间" readonly data-beatpicker="true" data-beatpicker-module="clear" data-beatpicker-id="myDatePicker">
                </div>
            </div>
            <div class="chart" id="container">
            </div>
        </div>
        <div class="box mt">
            <div class="top">
                <h2>部门业绩对比图</h2>
                <input type="text" id="branch1" class="branch branch1" placeholder="选择部门" readonly autocomplete="off">
                <ul id="ul1" style="left: 198px">
                    <li>部门一</li>
                    <li>部门二</li>
                    <li>部门三</li>
                    <li>部门四</li>
                    <li>部门五</li>
                    <li>部门六</li>
                </ul>
                <div  style="display: inline-block;margin-left: -50px">
                    <input type="text" id="" class="time" placeholder="结束时间" readonly data-beatpicker="true" data-beatpicker-module="clear">
                </div>
                <div  style="display: inline-block;margin-left: 100px">
                    <input type="text" id="" class="time timeML" placeholder="结束时间" readonly data-beatpicker="true" data-beatpicker-module="clear">
                </div>
            </div>
            <div class="chart"></div>
        </div>
        <div class="box mt">
            <div class="top">
                <h2>部门资产结构图</h2>
                <input type="text" id="branch2" class="branch" placeholder="选择部门" readonly>
                <ul id="ul2">
                    <li>部门一</li>
                    <li>部门二</li>
                    <li>部门三</li>
                    <li>部门四</li>
                    <li>部门五</li>
                    <li>部门六</li>
                </ul>
                <div  style="display: inline-block;margin-left: -50px">
                    <input type="text" id="" class="time" placeholder="结束时间" readonly data-beatpicker="true" data-beatpicker-module="clear">
                </div>
                <div  style="display: inline-block;margin-left: 100px">
                    <input type="text" id="" class="time timeML" placeholder="结束时间" readonly data-beatpicker="true" data-beatpicker-module="clear">
                </div>
            </div>
            <div class="chart"></div>
        </div>
    </div>


</block>

<block name="script">
    <script><if condition="($Think.request.status neq '') OR ($Think.request.s_time neq '') OR ($Think.request.e_time neq '') ">toggel("reSearchM");<else />toggel("RCsearch");</if></script>
    <script src="__JS__/BeatPicker.min.js"></script>
    <script src="__JS__/changeDate.js"></script>
    <script src="__JS__/highcharts.js"></script>
    <script type="text/javascript">

        $(function(){
            myDatePicker.on("select",function(data){
                var start_date = $("#start").val();
                var end_date = data.string;
                var branch_name = $("#branch").val();
                if(!branch_name){
                    alert('请选择部门')
                    return
                }
                if(!start_date){
                    alert('请选择开始时间')
                    return
                }
                if(DateToUnix(start_date)>DateToUnix(end_date)){
                    alert("结束时间须大于开始时间")
                    return
                }
                var url = 'admin/' + 'first_page-getassetproffitloss.html';
                var data={'start_date':start_date,'end_date':end_date,'branch_name':branch_name};
                $.get(url,data,function(response){
                    var working_capital_data = response['working_capital_data'];
                    var add_money_product = response['add_money_product'];
                    var date_array = response['date_array'];
                    var branch_name = response['branch_name'];
                    var title = {text: '部门'};
                    var subtitle = {text: branch_name};
                    var xAxis = {categories:date_array};
                    var yAxis = {title: {text: '金额 (元)'},
                        plotLines: [{
                            value: 0,
                            width: 1,
                            color: '#808080'
                        }]
                    };
                    var tooltip = {valueSuffix: '元',shared:true}
                    var legend = {layout: 'vertical', align: 'right', verticalAlign: 'large', borderWidth: 0};
                    var series =  [
                        {name: '可用资产', data:add_money_product},
                        {name: '运营资金', data: working_capital_data}
                    ];
                    var json = {};
                    json.title = title;
                    json.subtitle = subtitle;
                    json.xAxis = xAxis;
                    json.yAxis = yAxis;
                    json.tooltip = tooltip;
                    json.legend = legend;
                    json.series = series;
                    $('#container').highcharts(json);
                })
            })
        })

        $(function(){

            $("#branch").on('click',function(event){
               $('#ul').show()
                event.stopPropagation()
            })
            $(document).on('click',function(){
                $('#ul').hide()
            })
            $("#ul li").each(function(index,value){
                $(value).on('mouseover',function(){
                    $(this).css('background','#dcd5ec')
                }).on('mouseout',function(){
                    $(this).css('background','white')
                }).on('click',function(event){
                    $("#branch").val($(this).text())
                    event.stopPropagation()
                    $('#ul').hide()
                })
            })

            $("#branch1").on('click',function(event){
                $('#ul1').show()
                event.stopPropagation()
            })
            $(document).on('click',function(){
                $('#ul1').hide()
            })
            //实现可以选择三个部门
            var i = 0;
            $("#ul1 li").each(function(index,value){
                $(value).on('mouseover',function(){
                    $(this).css('background','#dcd5ec')
                }).on('mouseout',function(){
                    if(!$(this).attr('index')){
                        $(this).css('background','white')
                    }
                }).on('click',function(event){
                    if($(this).attr('index')){
                        $(this).css('background','white')
                        $(this).removeAttr('index')
                    }else{
                        $(this).attr('index',i);
                        var branch = $("#branch1").val();
                        if(branch){
                            branch = branch +',' +$(this).text();
                        }else{
                            branch = $(this).text();
                        }
                        //如果超过三个部门，就把最初的那个删除掉
                       if($("#ul1 li[index]").length > 3){
                           var j = [];;
                           $("#ul1 li[index]").each(function(index,value){
                               j.push($(value).attr('index'))
                           })
                           var min = Math.min.apply(null, j)
                           $("#ul1 li[index="+min +"]").css('background','white');
                           $("#ul1 li[index="+min +"]").removeAttr('index');
                           var branchArray = branch.split(',')
                           branch = branchArray[1] +',' + branchArray[2] + ',' +branchArray[3]
                       }
                        i++;
                        $("#branch1").val(branch);
                    }
                    event.stopPropagation()
                })
            })

            $("#branch2").on('click',function(event){
                $('#ul2').show()
                event.stopPropagation()
            })
            $(document).on('click',function(){
                $('#ul2').hide()
            })
            $("#ul2 li").each(function(index,value){
                $(value).on('mouseover',function(){
                    $(this).css('background','#dcd5ec')
                }).on('mouseout',function(){
                    $(this).css('background','white')
                }).on('click',function(event){
                    $("#branch2").val($(this).text())
                    event.stopPropagation()
                    $('#ul').hide()
                })
            })
        })

    </script>
</block>